# 外中断控制器

## 目录

- GP 异常码的解释
- 内联汇编的解释
- 80486 的解释
- 中断向量的解释
- 外中断细节调试
    - IF 位
    - 0x206;
    - 0b_0010_0000_0110;
- 中断控制器编程

```c++
void pic_init();
void send_eoi(int vector);
```

## EFLAGS 程序状态字

![](./images/eflags.drawio.svg)

## PC 中断默认级联图

![](./images/8259a.drawio.svg)

## 中断控制器编程

在 8259A 内部有两组寄存器：

- 初始化命令寄存器组，保存初始化命令字 (Initialization Command Words, ICW), ICW 共 4 个， ICW1 ~ ICW4；
- 操作命令寄存器组，保存操作命令字 (Operation Command Word, OCW), OCW 共 3 个， OCW1 ~ OCW3；

ICW 做初始化，用来确定是否需要级联，设置起始中断向量号，设置中断结束模式。其编程就是往 8259A 的端口发送一系列 ICW。由于从一开始就要决定 8259A 的工作状态，所以要一次性写入很多设置，某些设置之间是具有关联、依赖性的，也许后面的某个设置会依赖前面某个 ICW 写入的设置，所以这部分要求严格的顺序，必须依次写入 ICW1、ICW2、ICW3、ICW4；

OCW 来操作控制 8259A，前面所说的中断屏蔽和中断结束，就是通过往 8259A 端口发送 OCW 实现的。OCW 的发送顺序不固定，3 个之中先发送哪个都可以。

---

### ICW1 连接 / 触发方式

ICW1 用来初始化 8259A 的 **连接方式** 和中断信号的 **触发方式**；

- 连接方式 是指用单片工作，还是用多片级联工作；
- 触发方式 是指中断请求信号是电平触发，还是边沿触发；

如下表所示，共一个字节；

| 7   | 6   | 5   | 4   | 3    | 2   | 1     | 0   |
| --- | --- | --- | --- | ---- | --- | ----- | --- |
| 0   | 0   | 0   | 1   | LTIM | ADI | SINGL | IC4 |

ICW1 需要写入到主片的 `0x20` 端口和从片的 `0xA0` 端口；

IC4 表示是否要写入 ICW4，这表示，并不是所有的 ICW 初始化控制字都需要用到；IC4 为 1 时表示需要在后面写入 ICW4 ，为 0 ICW1 则不需要。注意，x86 系统 IC4 必须为1

SNGL 表示 single，若 SNGL 为 1 ，表示单片，若 SNGL 为 0，表示级联(Cascade)。若在级联模式下，这要涉及到主片和从片用哪个 sIRQ 接口互相连接的问题，所以当 SNGL 为 0 时，主片和从片也是需要 ICW3 的。

ADI 表示 Call Address Interval，用来设置 8085 的调用时间间隔， x86 不需要设置。

LTIM 表示 Level/Edge Triggered Mode，用来设置中断检测方式，LTIM 为 0 表示边沿触发，LTIM 为 1 表示电平触发；

第 4 位的 1 是固定的，这是 ICW1 的标记；

第 5 ~ 7 位专用于 8085 处理器，x86 不需要，直接置为 0 即可；

---

### ICW2 向量号

ICW2 用来设置 **起始中断向量号**，一般为 `0x20`，如下表所示，共一个字节；

| 7   | 6   | 5   | 4   | 3   | 2   | 1   | 0   |
| --- | --- | --- | --- | --- | --- | --- | --- |
| T7  | T6  | T5  | T4  | T3  | ID2 | ID1 | ID0 |

由于每个 8259A 芯片上的 IRQ 接口是顺序排列的，所以咱们这里的设置就是指定 IRQ0 映射到的中断向量号，其他 IRQ 接口对应的中断向量号会顺着自动排列下去。

ICW2 需要写入到主片的 `0x21` 端口和从片的 `0xA1`；

由于咱们只需要设置 IRQ0 的中断向量号， IRQ1~IRQ7 的中断向量号是 IRQ0 的顺延，所以，只需填写高 5 位 T3~T7，ID0~ID2 这低 3 位不用填。

由于只填写高 5 位，所以任意数字都是 8 的倍数，这个数字表示的便是设定的起始中断向量号。

这是有意设计的，低 3 位能表示 8 个中断向量号，这由 8259A 根据 8 个 IRQ 接口的排列位次自行导入，IRQ0 的值是 000, IRQ1 的值是001, IRQ2 的值便是 010 ... 以此类推，这样高 5 位加低 3 位，便表示了任意一个 IRQ 接口实际分配的中断向量号。

### ICW3 级联方式

ICW3 仅在 **级联的方式** 下才需要 (如果 ICW1 中的 SNGL 为 0)，用来设置主片和从片用哪个 IRQ 接口互连。

由于主片和从片的级联方式不一样，对于这个 ICW3，主片和从片都有自己不同的结构。

对于主片，ICW3 中置 1 的那一位对应的 IRQ 接口用于连接从片，若为 0 则表示接外部设备。比如，若主片 IRQ2 和 IRQ5 接有从片，则主片的 ICW3 为 00100100。

主片如下表所示，共一个字节；

| 7   | 6   | 5   | 4   | 3   | 2   | 1   | 0   |
| --- | --- | --- | --- | --- | --- | --- | --- |
| S7  | S6  | S5  | S4  | S3  | S2  | S1  | S0  |

对于从片，要设置与主片 8259A 的连接方式，不需要指定用自己的哪个 IRQ 接口与主片连接，从片上专门用于级联主片的接口并不是 IRQ。

从片如下表所示，共一个字节；

| 7   | 6   | 5   | 4   | 3   | 2   | 1   | 0   |
| --- | --- | --- | --- | --- | --- | --- | --- |
| 0   | 0   | 0   | 0   | 0   | ID2 | ID1 | ID0 |


如果从片用 IRQ 接口连接主片，若主片只级联一个从片，在从片上指定的 IRQ 接口便默认与主片上做级联的那个 IRQ 接口匹配了。但如果主片级联多个从片时，在从片上还要设置自己用于连接主片的 IRQ 接口与主片上连接从片的哪个 IRQ 接口（有多个）对接，这反而更麻烦。所以，设置从片连接主片的方法是只需要在从片上指定主片用于连接自己的那个 IRQ 接口就行了。

在中断响应时，主片会发送与从片做级联的 IRQ 接口号，所有从片用自己的 ICW3 的低 3 位和它对比，若一致则认为是发给自己的。

比如主片用 IRQ2 接口连接从片 A，用 IRQ5 接口连接从片 B；从片 A 的 ICW3 的值应该设为 0b00000010，就是十进制数 2，从片 B 的 ICW3 的值应该设为 0b00000101，就是十进制数 5；所以，从片 ICW3 中的低 3 位 ID0 ~ ID2 就够了，高 5 位不需要，为 0 即可。

---

### ICW4 工作模式

ICW4 用于设置 8259A 的 **工作模式**，当 ICW1 中的 IC4 为 1 时才需要 ICW4；

如下表所示，共一个字节；

| 7   | 6   | 5   | 4    | 3   | 2   | 1    | 0   |
| --- | --- | --- | ---- | --- | --- | ---- | --- |
| 0   | 0   | 0   | SFNM | BUF | M/S | AEOI | μPM |

ICW4 需要写入主片的 `0x21` 及从片的 `0xA1` 端口；

第 7~5 位未定义，直接置为 0 即可；

SFNM 表示特殊全嵌套模式(Special Fully Nested Mode)，若 SFNM 为 0，则表示全嵌套模式，若 SFNM 为 1，则表示特殊全嵌套模式。

BUF 表示本 8259A 芯片是否工作在缓冲模式。BUF 为 0 ，则工作非缓冲模式，BUF 为 1 ，则工作在缓冲模式。

M/S 用于指定主片和从片；当多个 8259A 级联时，如果工作在缓冲模式下(BUF = 1)，若 M/S 为 1 ，则表示则表示是主片，若 M/S 为0，则表示是从片。若工作在非缓冲模式下(BUF = 0)， M/S 无效。

AEOI 表示自动结束中断 (Auto End Of Interrupt)，8259A 在收到中断结束信号时才能继续处理下一个中断，此项用来设置是否要让 8259A 自动把中断结束。

- 若 AEOI 为 0 ，则表示非自动，即手动结束中断，可以在中断处理程序中手动向 8259A 的主、从片发送 EOI 信号。这种 **操作** 类命令，通过下面要介绍的 OCW 进行；
- 若 AEOI 为 1 ，则表示自动结束中断；

μPM 表示微处理器类型 (microprocessor)，此项是为了兼容老处理器。若 μPM 为 0，则表示 8080 或 8085 处理器，若 μPM 为1 ，则表示 x86 处理器。

---

### OCW1 屏蔽字

OCW1 用来屏蔽连接在 8259A 上的外部设备的中断信号，如下表所示，共一个字节；

| 7   | 6   | 5   | 4   | 3   | 2   | 1   | 0   |
| --- | --- | --- | --- | --- | --- | --- | --- |
| M7  | M6  | M5  | M4  | M3  | M2  | M1  | M0  |

实际上就是把 OCW1 写入了即 IMR 寄存器。这里的屏蔽是说是否把来自外部设备的中断信号转发给 CPU。由于外部设备的中断都是可屏蔽中断，所以最终还是要受标志寄存器 eflags 中的 IF 位的管束，若 IF 为 0，可屏蔽中断全部被屏蔽，也就是说，在 IF 为 0 的情况下，即使 8259A 把外部设备的中断向量号发过来，CPU 也置之不理。

OCW1 要写入主片的 `0x21` 或从片的 `0xA1` 端口；

---

### OCW2 结束方式

OCW2 用来设置中断结束方式和优先级模式，如下表所示，共一个字节；

| 7   | 6   | 5   | 4   | 3   | 2   | 1   | 0   |
| --- | --- | --- | --- | --- | --- | --- | --- |
| R   | SL  | EOI | 0   | 0   | L2  | L1  | L0  |

OCW2 要写入主片的 `0x20` 或从片的 `0xA0` 端口；

高 3 位 R、SL、EOI 可以定义多种 **中断结束方式** 和 **优先级循环方式**。

R (Rotation)，表示是否按照循环方式设置中断优先级。R 为 1 表示优先级自动循环， R 为 0 表示不自动循环，采用固定优先级方式。

- 如果 R 为 0，表示固定优先级方式，即 IRQ 接口号越低，优先级越高。
- 如果 R 为 1，表明用循环优先级方式，这样优先级会在 0~7 内循环，具体解释见下文；

SL (Specific Level)，表示是否指定优先等级。等级是用低 3 位来指定的。此处的 SL 只是开启低 3 位的开关，所以 SL 也表示低3 位的 L2~L0 是否有效。SL 为 1 表示有效，SL 为 0 表示无效。

EOI (End Of Interrupt)，为中断结束命令位。令 EOI 为 1，则会令 ISR 寄存器中的相应位清 0，也就是将当前处理的中断清掉，表示处理结束。向 8259A 主动发送 EOI 是手工结束中断的做法，所以，使用此命令有个前提，就是 ICW4 中的 AEOI 位为 0，非自动结束中断时才用。

在手动结束中断 (AEOI 位为 0) 的情况下，如果中断来自主片，只需要向主片发送 EOI 就行了，如果中断来自从片，除了向从片发送 EOI 以外，还要再向主片发送 EOI。

第 4~3 位的 00 是 OCW2 的标识。

L2~L0 用来确定优先级的编码，这里分两种：

- 用于 EOI 时，表示被中断的优先级别；
- 用于优先级循环时，指定起始最低的优先级别；

---

优先级循环方式的解释：

首先 R 必须是 1；

如果 SL 为 0，初始的优先级次序为：

IR0 > IR1 > IR2 > IR3 > IR4 > IR5 > IR6 > IR7；

当某级别的中断被处理完成后，它的优先级别将变成最低，将最高优先级传给之前较之低一级别的中断请求，其他依次类推。所以，可循环方式多用于各中断源优先级相同的情况，优先级通过这种循环可以实现轮询处理。该循环可总结为如果循环优先级 IR(i) 优先级最低，则 IR(i + 1) 优先级最高；

如果 SL 为 1，若想指定 IR5 为最低的优先级，需要将 L2~L0 置为 101。这样，新的初始优先级循环是：

IR6 > IR7 > IR0 > IR1 > IR2 > IR3 > IR4 > IR5；

---

### OCW3 特殊 / 查询方式

OCW3 用来设定特殊屏蔽方式及查询方式，如下表所示，共一个字节；

| 7   | 6    | 5   | 4   | 3   | 2   | 1   | 0   |
| --- | ---- | --- | --- | --- | --- | --- | --- |
| /   | ESMM | SMM | 0   | 1   | P   | RR  | RIS |

OCW2 要写入主片的 `0x20` 或从片的 `0xA0` 端口；

第 7 位未用到；

ESMM (Enable Special Mask Mode) 和 SMM (Special Mask Mode) 是组合在一起用的，用来启用或禁用特殊屏蔽模式。

ESMM 是特殊屏蔽模式允许位，是个开关。SMM 是特殊屏蔽模式位。只有在启用特殊屏蔽模式时，特殊屏蔽模式才有效。也就是若 ESMM 为 0，则 SMM 无效。若 ESMM 为 1，SMM 为 0，表示未工作在特殊屏蔽模式。若 ESMM 和 SMM 都为 1，这才正式工作在特殊屏蔽模式下。

第 4~3 位的 01 是 OCW3 的标识，8259A 通过这两位判断是哪个控制字。

P(Poll command)，查询命令，当 P 为 1 时，设置 8259A 为中断查询方式，这样就可以通过读取寄存器，如 IRS，来查看当前的中断处理情况。

RR，Read Register，读取寄存器命令。它和 RIS 位是配合在一起使用的。当 RR 为 1 时才可以读取寄存器。

RIS，Read Interrupt register Select，读取中断寄存器选择位，顾名思义，就是用此位选择待读取的寄存器。有点类似显卡寄存器中的索引的意思。若 RIS 为 1，表示选择 ISR 寄存器，若 RIS 为 0，表示选择 IRR 寄存器。这两个寄存器能否读取，前提是 RR 的值为 1。

---

## 其他的问题

8259A 就 2 个端口地址，它是如何识别 4 个 ICW 和 3 个 OCW 的？

ICW1，OCW2，OCW3 是用偶地址端口主片的 `0x20` 或从片的 `0xA0` 写入。

ICW2~ICW4 和 OCW1 是用奇地址端口主片的 `0x21` 或从片的 `0xA1` 写入。

以上 4 个 ICW 要保证一定的次序写入，8259A 就知道写入端口的数据是什么了。

---

OCW 的写入与顺序无关，并且 ICW1 和 OCW2, OCW3 的写入端口是一致的，8259A 怎样来辨识它们呢?

其实就是通过各控制字中的第 4~3 标识位，通过这两位的组合来唯一确定某个控制字，如下表；

| 控制字 | 第 4 位 | 第 3 位 |
| ------ | ------- | ------- |
| ICW1   | 1       | /       |
| OCW2   | 0       | 0       |
| OCW3   | 0       | 1       |

---

OCW1 是怎样确定的呢？

OCW 是在初始化之后才有效的，所以在初始化之后写入奇地址端口的数据便被认为是 OCW1。

---

### 编程步骤

- 无论 8259A 是否级联，ICW1 和 ICW2 是必须要有的，并且要顺序写入；

- 只有当 ICW1 中的 SNGL 位为 0 时，这表示级联，级联就需要设置主片和从片，这才需要在主片和从片中各写入 ICW3；注意， ICW3 的格式在主片和从片中是不同的；

- 只能在 ICW1 中的 IC4 为 1 时，才需要写入 ICW4。不过，x86 系统 IC4 必须为1；

- ICW 写完之后，才可以多 OCW 进行操作；

---

## 关键词

- 全嵌套模式
- Call Address Interval
- 缓冲模式
- 特殊屏蔽模式
- 中断查询方式

## 可能存在的问题

1. IRQ 9 为什么是 重定向的 IRQ 2？<sup><small>[[2]](#irq_9)</small></sup>

早期的 IBM PC/XT 只有一个 8259A，这样就只能处理 8 种 IRQ。但很快就发现这根本不能满足需求。所以到了IBM PC/AT，又以级连的方式增加了一个 8259A，这样就可以多处理 7 种 IRQ。原来的 8259A 被称作 Master PIC，新增的被称作 Slave PIC。但由于 CPU 只有 1 根中断线，Slave PIC 不得不级连在 Master PIC 上，占用了 IRQ2；

那么在 IBM PC/XT 上使用 IRQ2 的设备将无法再使用它；但新的系统又必须和原有系统保持兼容，怎么办？ 

由于新增加的 Slave PIC 在原有系统中不存在，所以，设计者从 Slave PIC 的 IRQ 中挑出 IRQ9，要求软件设计者将原来的 IRQ2 重定向到 IRQ9 上，也就是说 IRQ9 的中断服务程序需要去调用 IRQ2 的中断服务程序。这样，将原来接在 IRQ2 上的设备现在接在 IRQ9 上，在软件上只需要增加 IRQ9 的中断服务程序，由它调用 IRQ2 的中断服务程序，就可以和原有系统保持兼容。而在当时，增加的 IRQ9 中断服务程序是由 PC 开发商开发的 BIOS 提供的，不需要用户进行另外设置。所以就从根本上保证了兼容。

---

2. **边沿触发** 还是 **电平触发**？<sup><small>[[4]](#triggered)</small></sup>

ISA 总线不支持电平触发的中断，电平触发中断模式可能在 ISA 设备上无法使用，这意味着 PC/XT, PC/AT 以及兼容系统的 8259 **必须编程为边沿触发模式**。

一般来说电平触发要比边沿触发快，因为边沿触发依赖于时钟信号的电平变化；

---

## 参考文献

1. [486_DX_Microprocessor_Data_Book_(October_1992)](https://en.wikichip.org/w/images/8/80/486_DX_Microprocessor_Data_Book_%28October_1992%29.pdf)
2. [Intel 8259a Datasheet](https://pdos.csail.mit.edu/6.828/2010/readings/hardware/8259A.pdf)
3. <https://www.renesas.com/eu/en/document/apn/an109-82c59a-priority-interrupt-controller?language=en>
4. <https://chamilo.grenoble-inp.fr/courses/ENSIMAG4MMPCSEF/document/traps.pdf>
5. 赵炯 - 《Linux 内核完全注释》
6. 郑刚 - 《操作系统真象还原》
7. <a id='irq_9'/><https://zhidao.baidu.com/question/202616135701756405.html>
8. <a id='triggered'/><https://en.wikipedia.org/wiki/Intel_8259#Edge_and_level_triggered_modes>
